<?php
/**
 * Bootstrap 5 Form Layout Template
 * 
 * Form template with Bootstrap 5 CSS classes and structure
 * 
 * Available variables:
 * @var \Core\Forms\FormDefinition $form The form definition
 * @var array $context Rendering context
 * @var array $options Rendering options
 */

// Get form data
$formName = $form->getName();
$formAction = $form->getAction();
$formMethod = $form->getMethod();
$formEnctype = $form->getEnctype();
$formAttributes = $form->getFormAttributes();

// Get fields
$fields = $form->getFields();

// Get global errors
$globalErrors = $context['global_errors'] ?? [];
$fieldErrors = $context['errors'] ?? [];

// CSRF
$csrfEnabled = $form->isCsrfEnabled();
$csrfField = $context['csrf_field'] ?? '';

// Render options
$showLabels = $options['show_labels'] ?? true;
$showSubmitButton = $options['show_submit_button'] ?? true;
$submitButtonText = $options['submit_button_text'] ?? 'Submit';
$submitButtonClass = $options['submit_button_class'] ?? 'btn btn-primary';

// Build form attributes
$formAttrString = '';
foreach ($formAttributes as $name => $value) {
    $formAttrString .= sprintf(
        ' %s="%s"',
        htmlspecialchars($name, ENT_QUOTES, 'UTF-8'),
        htmlspecialchars($value, ENT_QUOTES, 'UTF-8')
    );
}
?>
<form 
    name="<?= htmlspecialchars($formName, ENT_QUOTES, 'UTF-8') ?>" 
    action="<?= htmlspecialchars($formAction, ENT_QUOTES, 'UTF-8') ?>" 
    method="<?= htmlspecialchars($formMethod, ENT_QUOTES, 'UTF-8') ?>"
    <?php if ($formEnctype): ?>
    enctype="<?= htmlspecialchars($formEnctype, ENT_QUOTES, 'UTF-8') ?>"
    <?php endif; ?>
    <?= $formAttrString ?>
>
    <?php if (!empty($globalErrors)): ?>
    <div class="alert alert-danger" role="alert">
        <h5 class="alert-heading">Form Errors</h5>
        <ul class="mb-0">
            <?php foreach ($globalErrors as $error): ?>
            <li><?= htmlspecialchars($error, ENT_QUOTES, 'UTF-8') ?></li>
            <?php endforeach; ?>
        </ul>
    </div>
    <?php endif; ?>
    
    <?php if ($csrfEnabled && $csrfField): ?>
    <?= $csrfField ?>
    <?php endif; ?>
    
    <?php foreach ($fields as $field): ?>
    <?php
    // Skip hidden fields from standard rendering
    if ($field->getType() === 'hidden') {
        echo $field->render($context);
        continue;
    }
    
    $fieldName = $field->getName();
    $fieldId = $field->getAttribute('id', $fieldName);
    $fieldLabel = $field->getLabel();
    $fieldHelp = $field->getHelpText();
    $isRequired = $field->isRequired();
    $fieldType = $field->getType();
    
    // Get field errors
    $errors = $fieldErrors[$fieldName] ?? [];
    if (!is_array($errors)) {
        $errors = [$errors];
    }
    $hasErrors = !empty($errors);
    ?>
    
    <div class="mb-3">
        <?php if ($showLabels && $fieldLabel): ?>
        <label for="<?= htmlspecialchars($fieldId, ENT_QUOTES, 'UTF-8') ?>" class="form-label">
            <?= htmlspecialchars($fieldLabel, ENT_QUOTES, 'UTF-8') ?>
            <?php if ($isRequired): ?>
            <span class="text-danger">*</span>
            <?php endif; ?>
        </label>
        <?php endif; ?>
        
        <?php
        // Add Bootstrap classes to field
        $fieldClasses = $field->getAttribute('class', '');
        
        if ($fieldType === 'select') {
            $fieldClasses = trim($fieldClasses . ' form-select');
        } elseif ($fieldType === 'file') {
            $fieldClasses = trim($fieldClasses . ' form-control');
        } elseif ($fieldType === 'textarea') {
            $fieldClasses = trim($fieldClasses . ' form-control');
        } elseif ($fieldType !== 'composite') {
            $fieldClasses = trim($fieldClasses . ' form-control');
        }
        
        if ($hasErrors) {
            $fieldClasses = trim($fieldClasses . ' is-invalid');
        }
        
        $field->setAttribute('class', $fieldClasses);
        
        // Render the field
        echo $field->render($context);
        ?>
        
        <?php if ($fieldHelp): ?>
        <div class="form-text"><?= htmlspecialchars($fieldHelp, ENT_QUOTES, 'UTF-8') ?></div>
        <?php endif; ?>
        
        <?php if ($hasErrors): ?>
        <div class="invalid-feedback d-block">
            <?php foreach ($errors as $error): ?>
            <div><?= htmlspecialchars($error, ENT_QUOTES, 'UTF-8') ?></div>
            <?php endforeach; ?>
        </div>
        <?php endif; ?>
    </div>
    <?php endforeach; ?>
    
    <?php if ($showSubmitButton): ?>
    <div class="d-grid gap-2">
        <button type="submit" class="<?= htmlspecialchars($submitButtonClass, ENT_QUOTES, 'UTF-8') ?>">
            <?= htmlspecialchars($submitButtonText, ENT_QUOTES, 'UTF-8') ?>
        </button>
    </div>
    <?php endif; ?>
</form>
