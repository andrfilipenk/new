<section id="forms" class="content-section active">
    <div class="page-header">
        <h1 class="page-title">Forms & Input Handling</h1>
        <p class="page-subtitle">Building secure and user-friendly forms</p>
    </div>

    <div class="toc">
        <h6>Table of Contents</h6>
        <ul>
            <li><a href="#form-basics">Form Basics</a></li>
            <li><a href="#form-builders">Form Builders</a></li>
            <li><a href="#input-handling">Input Handling</a></li>
            <li><a href="#file-uploads">File Uploads</a></li>
        </ul>
    </div>

    <h2 id="form-basics">Form Basics</h2>

    <h3>Basic Form Template</h3>
    <div class="code-example" data-title="Basic Form Structure">
        <pre><code class="language-php"><?php // user/form.phtml ?>
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5><?= isset($user) ? 'Edit User' : 'Create User' ?></h5>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data">
                        <!-- CSRF Token -->
                        <input type="hidden" name="_token" value="<?= $this->getCsrfToken() ?>">
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="first_name" class="form-label">First Name *</label>
                                    <input type="text" class="form-control" id="first_name" name="first_name" 
                                           value="<?= $this->escape($data['first_name'] ?? $user->first_name ?? '') ?>" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="last_name" class="form-label">Last Name *</label>
                                    <input type="text" class="form-control" id="last_name" name="last_name" 
                                           value="<?= $this->escape($data['last_name'] ?? $user->last_name ?? '') ?>" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="email" class="form-label">Email *</label>
                            <input type="email" class="form-control" id="email" name="email" 
                                   value="<?= $this->escape($data['email'] ?? $user->email ?? '') ?>" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="department" class="form-label">Department</label>
                            <select class="form-select" id="department" name="department">
                                <option value="">Select Department</option>
                                <?php 
                                $departments = ['IT', 'HR', 'Sales', 'Marketing', 'Finance'];
                                $selectedDept = $data['department'] ?? $user->department ?? '';
                                ?>
                                <?php foreach ($departments as $dept): ?>
                                    <option value="<?= $dept ?>" <?= $selectedDept === $dept ? 'selected' : '' ?>>
                                        <?= $dept ?>
                                    </option>
                                <?php endforeach; ?>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="is_active" name="is_active" value="1"
                                       <?= ($data['is_active'] ?? $user->is_active ?? true) ? 'checked' : '' ?>>
                                <label class="form-check-label" for="is_active">Active</label>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <a href="<?= $this->url('admin/user') ?>" class="btn btn-secondary">Cancel</a>
                            <button type="submit" class="btn btn-primary">
                                <?= isset($user) ? 'Update' : 'Create' ?> User
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div></code></pre>
    </div>

    <h2 id="form-builders">Form Builders</h2>

    <h3>Form Builder Class</h3>
    <div class="code-example" data-title="Form Builder Implementation">
        <pre><code class="language-php"><?php
// app/Admin/Form/UserForm.php
namespace Admin\Form;

class UserForm
{
    protected $data = [];
    protected $errors = [];
    
    public function __construct(array $data = [], array $errors = [])
    {
        $this->data = $data;
        $this->errors = $errors;
    }
    
    public static function build(array $data = [], array $errors = []): self
    {
        return new static($data, $errors);
    }
    
    public function render(): string
    {
        ob_start();
        ?>
        <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
            <?= $this->renderField('text', 'name', 'Full Name', ['required' => true]) ?>
            <?= $this->renderField('email', 'email', 'Email Address', ['required' => true]) ?>
            <?= $this->renderField('select', 'department', 'Department', [
                'options' => ['IT' => 'IT', 'HR' => 'HR', 'Sales' => 'Sales']
            ]) ?>
            <?= $this->renderField('password', 'password', 'Password', ['required' => !isset($this->data['id'])]) ?>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Save</button>
                <a href="/admin/user" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
        <?php
        return ob_get_clean();
    }
    
    protected function renderField(string $type, string $name, string $label, array $options = []): string
    {
        $value = $this->data[$name] ?? '';
        $error = $this->errors[$name][0] ?? '';
        $required = $options['required'] ?? false;
        $cssClass = 'form-control' . ($error ? ' is-invalid' : '');
        
        ob_start();
        ?>
        <div class="mb-3">
            <label for="<?= $name ?>" class="form-label">
                <?= htmlspecialchars($label) ?><?= $required ? ' *' : '' ?>
            </label>
            
            <?php if ($type === 'select'): ?>
                <select class="form-select<?= $error ? ' is-invalid' : '' ?>" id="<?= $name ?>" name="<?= $name ?>" <?= $required ? 'required' : '' ?>>
                    <option value="">Choose...</option>
                    <?php foreach ($options['options'] ?? [] as $optValue => $optLabel): ?>
                        <option value="<?= $optValue ?>" <?= $value == $optValue ? 'selected' : '' ?>>
                            <?= htmlspecialchars($optLabel) ?>
                        </option>
                    <?php endforeach; ?>
                </select>
            <?php else: ?>
                <input type="<?= $type ?>" class="<?= $cssClass ?>" id="<?= $name ?>" name="<?= $name ?>" 
                       value="<?= htmlspecialchars($value) ?>" <?= $required ? 'required' : '' ?>>
            <?php endif; ?>
            
            <?php if ($error): ?>
                <div class="invalid-feedback"><?= htmlspecialchars($error) ?></div>
            <?php endif; ?>
        </div>
        <?php
        return ob_get_clean();
    }
}</code></pre>
    </div>

    <h2 id="input-handling">Input Handling</h2>

    <h3>Request Processing</h3>
    <div class="code-example" data-title="Handling Form Data">
        <pre><code class="language-php"><?php
class UserController extends Controller
{
    public function createAction()
    {
        if ($this->isPost()) {
            // Get all form data
            $data = $this->getRequest()->all();
            
            // Get specific fields
            $name = $this->getPost('name');
            $email = $this->getPost('email');
            
            // Sanitize input
            $data = $this->sanitizeInput($data);
            
            // Validate
            $validation = $this->validateUser($data);
            if (!$validation['valid']) {
                return $this->render('user/form', [
                    'data' => $data,
                    'errors' => $validation['errors']
                ]);
            }
            
            // Process the data
            $user = $this->createUser($data);
            
            if ($user) {
                $this->flashSuccess('User created successfully');
                return $this->redirect('admin/user');
            }
        }
        
        return $this->render('user/form');
    }
    
    protected function sanitizeInput(array $data): array
    {
        foreach ($data as $key => $value) {
            if (is_string($value)) {
                // Remove dangerous characters
                $data[$key] = htmlspecialchars(trim($value), ENT_QUOTES, 'UTF-8');
            }
        }
        return $data;
    }
    
    protected function createUser(array $data): ?User
    {
        try {
            $user = new User();
            $user->fill($data);
            
            // Hash password if provided
            if (!empty($data['password'])) {
                $user->password = $data['password']; // Will be hashed in model
            }
            
            return $user->save() ? $user : null;
        } catch (Exception $e) {
            $this->flashError('Error creating user: ' . $e->getMessage());
            return null;
        }
    }
}</code></pre>
    </div>

    <h2 id="file-uploads">File Uploads</h2>

    <h3>File Upload Form</h3>
    <div class="code-example" data-title="File Upload Interface">
        <pre><code class="language-php"><?php // File upload form ?>
<form method="post" enctype="multipart/form-data">
    <div class="mb-3">
        <label for="profile_image" class="form-label">Profile Image</label>
        <input type="file" class="form-control" id="profile_image" name="profile_image" 
               accept="image/*" onchange="previewImage(this)">
        <div class="form-text">Max file size: 5MB. Allowed: JPG, PNG, GIF</div>
        
        <!-- Image preview -->
        <div id="image-preview" class="mt-2" style="display: none;">
            <img id="preview-img" src="" alt="Preview" class="img-thumbnail" style="max-width: 200px;">
        </div>
    </div>
    
    <div class="mb-3">
        <label for="documents" class="form-label">Documents</label>
        <input type="file" class="form-control" id="documents" name="documents[]" multiple 
               accept=".pdf,.doc,.docx,.txt">
        <div class="form-text">Multiple files allowed. Max 10MB per file.</div>
    </div>
    
    <button type="submit" class="btn btn-primary">Upload</button>
</form>

<script>
function previewImage(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('preview-img').src = e.target.result;
            document.getElementById('image-preview').style.display = 'block';
        };
        reader.readAsDataURL(input.files[0]);
    }
}
</script></code></pre>
    </div>

    <h3>File Upload Handling</h3>
    <div class="code-example" data-title="Processing File Uploads">
        <pre><code class="language-php"><?php
class UserController extends Controller
{
    public function uploadAction()
    {
        if ($this->isPost()) {
            $uploadService = $this->getDI()->get('upload');
            $user = User::find($this->getPost('user_id'));
            
            // Handle profile image
            if (isset($_FILES['profile_image']) && $_FILES['profile_image']['error'] === UPLOAD_ERR_OK) {
                $result = $uploadService->handleUpload('profile_image', [
                    'destination' => 'uploads/profiles/',
                    'allowed_types' => ['jpg', 'jpeg', 'png', 'gif'],
                    'max_size' => 5242880, // 5MB
                    'generate_name' => true
                ]);
                
                if ($result['success']) {
                    $user->profile_image = $result['file_path'];
                    $user->save();
                    $this->flashSuccess('Profile image uploaded successfully');
                } else {
                    $this->flashError('Upload failed: ' . $result['error']);
                }
            }
            
            // Handle multiple documents
            if (isset($_FILES['documents'])) {
                $uploadedFiles = $this->handleMultipleFiles($_FILES['documents'], $user);
                if (count($uploadedFiles) > 0) {
                    $this->flashSuccess(count($uploadedFiles) . ' documents uploaded successfully');
                }
            }
        }
        
        return $this->render('user/upload');
    }
    
    protected function handleMultipleFiles(array $files, User $user): array
    {
        $uploadService = $this->getDI()->get('upload');
        $uploadedFiles = [];
        
        for ($i = 0; $i < count($files['name']); $i++) {
            if ($files['error'][$i] === UPLOAD_ERR_OK) {
                $fileData = [
                    'name' => $files['name'][$i],
                    'type' => $files['type'][$i],
                    'tmp_name' => $files['tmp_name'][$i],
                    'error' => $files['error'][$i],
                    'size' => $files['size'][$i]
                ];
                
                $result = $uploadService->handleSingleUpload($fileData, [
                    'destination' => 'uploads/documents/',
                    'allowed_types' => ['pdf', 'doc', 'docx', 'txt'],
                    'max_size' => 10485760 // 10MB
                ]);
                
                if ($result['success']) {
                    // Save to database
                    $this->saveUserDocument($user, $result);
                    $uploadedFiles[] = $result;
                }
            }
        }
        
        return $uploadedFiles;
    }
    
    protected function saveUserDocument(User $user, array $fileInfo): void
    {
        $db = $this->getDI()->get('db');
        $db->table('user_documents')->insert([
            'user_id' => $user->id,
            'document_name' => $fileInfo['original_name'],
            'file_path' => $fileInfo['file_path'],
            'file_type' => $fileInfo['extension'],
            'file_size' => $fileInfo['size'],
            'created_at' => date('Y-m-d H:i:s')
        ]);
    }
}</code></pre>
    </div>

    <div class="alert alert-warning">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <strong>Security Warning:</strong> Always validate file types and sizes on the server side. Never trust client-side validation alone.
    </div>
</section>