<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Development Guide - Framework Documentation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8f9fa; }
        .container { max-width: 1200px; }
        .page-header { border-bottom: 2px solid #667eea; padding-bottom: 1rem; margin-bottom: 2rem; }
        .page-title { color: #667eea; font-weight: 700; margin: 0; }
        .code-example { background: #2d3748; border-radius: 8px; padding: 1.5rem; margin: 1rem 0; position: relative; }
        .code-example::before { content: attr(data-title); position: absolute; top: 0; left: 0; background: #667eea; color: white; padding: 0.25rem 0.75rem; border-radius: 8px 0 8px 0; font-size: 0.75rem; font-weight: 600; }
        .toc { background: #f8f9fa; border-left: 4px solid #667eea; padding: 1rem; margin: 1rem 0; border-radius: 0 8px 8px 0; }
        .alert-info { background: linear-gradient(135deg, #e3f2fd, #bbdefb); border: 1px solid #2196f3; color: #0d47a1; }
        .alert-warning { background: linear-gradient(135deg, #fff3e0, #ffcc02); border: 1px solid #ff9800; color: #e65100; }
        .alert-success { background: linear-gradient(135deg, #e8f5e8, #c8e6c9); border: 1px solid #4caf50; color: #1b5e20; }
        .nav-pills .nav-link { margin: 0.25rem; }
        .nav-pills .nav-link.active { background-color: #667eea; }
        .http-method { padding: 0.25rem 0.5rem; border-radius: 4px; color: white; font-weight: bold; font-size: 0.8rem; }
        .method-get { background-color: #28a745; }
        .method-post { background-color: #007bff; }
        .method-put { background-color: #ffc107; color: #212529; }
        .method-delete { background-color: #dc3545; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <!-- Navigation -->
        <nav class="mb-4">
            <ul class="nav nav-pills">
                <li class="nav-item"><a class="nav-link" href="index.html">Overview</a></li>
                <li class="nav-item"><a class="nav-link" href="installation-guide.html">Installation</a></li>
                <li class="nav-item"><a class="nav-link" href="mvc-guide.html">MVC</a></li>
                <li class="nav-item"><a class="nav-link" href="database-guide.html">Database</a></li>
                <li class="nav-item"><a class="nav-link" href="acl-guide.html">ACL</a></li>
                <li class="nav-item"><a class="nav-link" href="validation-guide.html">Validation</a></li>
                <li class="nav-item"><a class="nav-link" href="forms-guide.html">Forms</a></li>
                <li class="nav-item"><a class="nav-link active" href="api-guide.html">API</a></li>
                <li class="nav-item"><a class="nav-link" href="testing-guide.html">Testing</a></li>
                <li class="nav-item"><a class="nav-link" href="best-practices-guide.html">Best Practices</a></li>
            </ul>
        </nav>

        <!-- Content -->
        <div class="bg-white rounded p-4 shadow-sm">
            <div class="page-header">
                <h1 class="page-title">API Development</h1>
                <p class="page-subtitle text-muted">RESTful APIs, JSON responses, and authentication</p>
            </div>

            <div class="toc">
                <h6>Table of Contents</h6>
                <ul>
                    <li><a href="#rest-basics">REST API Basics</a></li>
                    <li><a href="#api-controllers">API Controllers</a></li>
                    <li><a href="#authentication">API Authentication</a></li>
                    <li><a href="#rate-limiting">Rate Limiting</a></li>
                    <li><a href="#documentation">API Documentation</a></li>
                    <li><a href="#testing-apis">Testing APIs</a></li>
                </ul>
            </div>

            <h2 id="rest-basics">REST API Basics</h2>
            <p>Build RESTful APIs following standard conventions for resources and HTTP methods.</p>

            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>REST Convention:</strong> Use HTTP methods (GET, POST, PUT, DELETE) with resource URLs for predictable API design.
            </div>

            <h3>API Routes</h3>
            <div class="code-example" data-title="routes/api.php">
                <pre><code class="language-php"><?php

// User API routes
$router->group(['prefix' => 'api/v1', 'middleware' => 'api'], function() use ($router) {
    
    // Authentication
    $router->post('/auth/login', 'Api\AuthController@login');
    $router->post('/auth/logout', 'Api\AuthController@logout');
    $router->post('/auth/refresh', 'Api\AuthController@refresh');
    
    // Protected routes
    $router->group(['middleware' => 'auth:api'], function() use ($router) {
        
        // Users resource
        $router->get('/users', 'Api\UserController@index');           // GET /api/v1/users
        $router->post('/users', 'Api\UserController@store');          // POST /api/v1/users
        $router->get('/users/{id}', 'Api\UserController@show');       // GET /api/v1/users/1
        $router->put('/users/{id}', 'Api\UserController@update');     // PUT /api/v1/users/1
        $router->delete('/users/{id}', 'Api\UserController@destroy'); // DELETE /api/v1/users/1
        
        // Posts resource
        $router->resource('posts', 'Api\PostController');
        
        // Nested resources
        $router->get('/users/{id}/posts', 'Api\UserController@posts');
        $router->get('/posts/{id}/comments', 'Api\PostController@comments');
    });
});</code></pre>
            </div>

            <h3>Standard HTTP Status Codes</h3>
            <div class="row">
                <div class="col-md-6">
                    <h5>Success Codes</h5>
                    <ul>
                        <li><strong>200 OK</strong> - Request successful</li>
                        <li><strong>201 Created</strong> - Resource created</li>
                        <li><strong>204 No Content</strong> - Successful deletion</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h5>Error Codes</h5>
                    <ul>
                        <li><strong>400 Bad Request</strong> - Invalid request</li>
                        <li><strong>401 Unauthorized</strong> - Authentication required</li>
                        <li><strong>403 Forbidden</strong> - Access denied</li>
                        <li><strong>404 Not Found</strong> - Resource not found</li>
                        <li><strong>422 Unprocessable Entity</strong> - Validation errors</li>
                    </ul>
                </div>
            </div>

            <h2 id="api-controllers">API Controllers</h2>

            <h3>Base API Controller</h3>
            <div class="code-example" data-title="app/Controllers/Api/BaseController.php">
                <pre><code class="language-php"><?php
namespace App\Controllers\Api;

use App\Controllers\Controller;

class BaseController extends Controller
{
    protected function success($data = null, $message = 'Success', $status = 200)
    {
        $response = [
            'success' => true,
            'message' => $message
        ];
        
        if ($data !== null) {
            $response['data'] = $data;
        }
        
        return response()->json($response, $status);
    }
    
    protected function error($message = 'Error', $status = 400, $errors = null)
    {
        $response = [
            'success' => false,
            'message' => $message
        ];
        
        if ($errors !== null) {
            $response['errors'] = $errors;
        }
        
        return response()->json($response, $status);
    }
    
    protected function paginate($query, $perPage = 15)
    {
        $page = (int) ($_GET['page'] ?? 1);
        $offset = ($page - 1) * $perPage;
        
        $total = $query->count();
        $items = $query->limit($perPage)->offset($offset)->get();
        
        return [
            'data' => $items,
            'pagination' => [
                'current_page' => $page,
                'per_page' => $perPage,
                'total' => $total,
                'last_page' => ceil($total / $perPage),
                'from' => $offset + 1,
                'to' => min($offset + $perPage, $total)
            ]
        ];
    }
}</code></pre>
            </div>

            <h3>User API Controller</h3>
            <div class="code-example" data-title="app/Controllers/Api/UserController.php">
                <pre><code class="language-php"><?php
namespace App\Controllers\Api;

use App\Models\User;
use App\Core\Validator;

class UserController extends BaseController
{
    public function index()
    {
        $users = User::query();
        
        // Search functionality
        if (isset($_GET['search'])) {
            $search = $_GET['search'];
            $users->where('name', 'LIKE', "%{$search}%")
                  ->orWhere('email', 'LIKE', "%{$search}%");
        }
        
        // Filter by status
        if (isset($_GET['status'])) {
            $users->where('status', $_GET['status']);
        }
        
        // Sort
        $sortBy = $_GET['sort_by'] ?? 'created_at';
        $sortOrder = $_GET['sort_order'] ?? 'desc';
        $users->orderBy($sortBy, $sortOrder);
        
        $result = $this->paginate($users);
        
        return $this->success($result, 'Users retrieved successfully');
    }
    
    public function store()
    {
        $validator = new Validator();
        $validation = $validator->validate($_POST, [
            'name' => 'required|min:2|max:50',
            'email' => 'required|email|unique:user,email',
            'password' => 'required|min:8'
        ]);
        
        if ($validation->fails()) {
            return $this->error('Validation failed', 422, $validation->errors());
        }
        
        $data = $validation->validated();
        $data['password'] = password_hash($data['password'], PASSWORD_DEFAULT);
        
        $user = User::create($data);
        
        return $this->success($user, 'User created successfully', 201);
    }
    
    public function show($id)
    {
        $user = User::find($id);
        
        if (!$user) {
            return $this->error('User not found', 404);
        }
        
        return $this->success($user, 'User retrieved successfully');
    }
    
    public function update($id)
    {
        $user = User::find($id);
        
        if (!$user) {
            return $this->error('User not found', 404);
        }
        
        $validator = new Validator();
        $validation = $validator->validate($_POST, [
            'name' => 'required|min:2|max:50',
            'email' => 'required|email|unique:user,email,' . $id,
            'status' => 'in:active,inactive'
        ]);
        
        if ($validation->fails()) {
            return $this->error('Validation failed', 422, $validation->errors());
        }
        
        $user->update($validation->validated());
        
        return $this->success($user, 'User updated successfully');
    }
    
    public function destroy($id)
    {
        $user = User::find($id);
        
        if (!$user) {
            return $this->error('User not found', 404);
        }
        
        $user->delete();
        
        return $this->success(null, 'User deleted successfully', 204);
    }
}</code></pre>
            </div>

            <h2 id="authentication">API Authentication</h2>

            <h3>JWT Authentication</h3>
            <div class="code-example" data-title="app/Controllers/Api/AuthController.php">
                <pre><code class="language-php"><?php
namespace App\Controllers\Api;

use App\Models\User;
use App\Core\JWT;

class AuthController extends BaseController
{
    public function login()
    {
        $email = $_POST['email'] ?? '';
        $password = $_POST['password'] ?? '';
        
        if (empty($email) || empty($password)) {
            return $this->error('Email and password are required', 400);
        }
        
        $user = User::where('email', $email)->first();
        
        if (!$user || !password_verify($password, $user->password)) {
            return $this->error('Invalid credentials', 401);
        }
        
        if ($user->status !== 'active') {
            return $this->error('Account is inactive', 403);
        }
        
        $token = JWT::encode([
            'user_id' => $user->id,
            'email' => $user->email,
            'exp' => time() + (24 * 60 * 60) // 24 hours
        ]);
        
        return $this->success([
            'user' => $user->toArray(),
            'token' => $token,
            'token_type' => 'Bearer',
            'expires_in' => 24 * 60 * 60
        ], 'Login successful');
    }
    
    public function logout()
    {
        // For JWT, logout is typically handled client-side
        // You might want to implement token blacklisting here
        
        return $this->success(null, 'Logged out successfully');
    }
    
    public function refresh()
    {
        $user = $this->getUser();
        
        if (!$user) {
            return $this->error('Invalid token', 401);
        }
        
        $token = JWT::encode([
            'user_id' => $user->id,
            'email' => $user->email,
            'exp' => time() + (24 * 60 * 60)
        ]);
        
        return $this->success([
            'token' => $token,
            'token_type' => 'Bearer',
            'expires_in' => 24 * 60 * 60
        ], 'Token refreshed successfully');
    }
}</code></pre>
            </div>

            <h3>API Authentication Middleware</h3>
            <div class="code-example" data-title="app/Middleware/ApiAuthMiddleware.php">
                <pre><code class="language-php"><?php
namespace App\Middleware;

use App\Core\JWT;
use App\Models\User;

class ApiAuthMiddleware
{
    public function handle($request, $next)
    {
        $header = $_SERVER['HTTP_AUTHORIZATION'] ?? '';
        
        if (!$header || !str_starts_with($header, 'Bearer ')) {
            return response()->json([
                'success' => false,
                'message' => 'Authorization token required'
            ], 401);
        }
        
        $token = substr($header, 7); // Remove "Bearer " prefix
        
        try {
            $payload = JWT::decode($token);
            
            $user = User::find($payload['user_id']);
            
            if (!$user || $user->status !== 'active') {
                throw new Exception('Invalid user');
            }
            
            // Add user to request
            $request->setUser($user);
            
        } catch (Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Invalid or expired token'
            ], 401);
        }
        
        return $next($request);
    }
}</code></pre>
            </div>

            <h2 id="rate-limiting">Rate Limiting</h2>

            <div class="code-example" data-title="app/Middleware/RateLimitMiddleware.php">
                <pre><code class="language-php"><?php
namespace App\Middleware;

class RateLimitMiddleware
{
    protected $limits = [
        'api' => ['requests' => 100, 'window' => 3600], // 100 requests per hour
        'auth' => ['requests' => 10, 'window' => 900]    // 10 requests per 15 minutes
    ];
    
    public function handle($request, $next, $type = 'api')
    {
        $identifier = $this->getIdentifier($request);
        $limit = $this->limits[$type] ?? $this->limits['api'];
        
        if ($this->isRateLimited($identifier, $limit)) {
            return response()->json([
                'success' => false,
                'message' => 'Rate limit exceeded. Too many requests.'
            ], 429);
        }
        
        $this->recordRequest($identifier, $limit);
        
        return $next($request);
    }
    
    protected function getIdentifier($request)
    {
        // Use user ID if authenticated, otherwise IP address
        $user = $request->getUser();
        
        if ($user) {
            return 'user:' . $user->id;
        }
        
        return 'ip:' . ($_SERVER['REMOTE_ADDR'] ?? 'unknown');
    }
    
    protected function isRateLimited($identifier, $limit)
    {
        $key = "rate_limit:{$identifier}";
        $current = apcu_fetch($key) ?: 0;
        
        return $current >= $limit['requests'];
    }
    
    protected function recordRequest($identifier, $limit)
    {
        $key = "rate_limit:{$identifier}";
        $current = apcu_fetch($key) ?: 0;
        
        apcu_store($key, $current + 1, $limit['window']);
    }
}</code></pre>
            </div>

            <h2 id="documentation">API Documentation</h2>

            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Documentation:</strong> Good API documentation is essential for developer adoption and maintenance.
            </div>

            <h3>API Endpoints</h3>
            
            <h4>Authentication</h4>
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Method</th>
                            <th>Endpoint</th>
                            <th>Description</th>
                            <th>Auth Required</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><span class="http-method method-post">POST</span></td>
                            <td><code>/api/v1/auth/login</code></td>
                            <td>User login</td>
                            <td>No</td>
                        </tr>
                        <tr>
                            <td><span class="http-method method-post">POST</span></td>
                            <td><code>/api/v1/auth/logout</code></td>
                            <td>User logout</td>
                            <td>Yes</td>
                        </tr>
                        <tr>
                            <td><span class="http-method method-post">POST</span></td>
                            <td><code>/api/v1/auth/refresh</code></td>
                            <td>Refresh token</td>
                            <td>Yes</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h4>Users</h4>
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Method</th>
                            <th>Endpoint</th>
                            <th>Description</th>
                            <th>Parameters</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><span class="http-method method-get">GET</span></td>
                            <td><code>/api/v1/users</code></td>
                            <td>List users</td>
                            <td>page, search, status, sort_by, sort_order</td>
                        </tr>
                        <tr>
                            <td><span class="http-method method-post">POST</span></td>
                            <td><code>/api/v1/users</code></td>
                            <td>Create user</td>
                            <td>name, email, password</td>
                        </tr>
                        <tr>
                            <td><span class="http-method method-get">GET</span></td>
                            <td><code>/api/v1/users/{id}</code></td>
                            <td>Get user</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td><span class="http-method method-put">PUT</span></td>
                            <td><code>/api/v1/users/{id}</code></td>
                            <td>Update user</td>
                            <td>name, email, status</td>
                        </tr>
                        <tr>
                            <td><span class="http-method method-delete">DELETE</span></td>
                            <td><code>/api/v1/users/{id}</code></td>
                            <td>Delete user</td>
                            <td>-</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h2 id="testing-apis">Testing APIs</h2>

            <div class="code-example" data-title="Example API Requests">
                <pre><code class="language-bash"># Login
curl -X POST http://localhost/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email": "admin@example.com", "password": "password"}'

# Get users (with token)
curl -X GET http://localhost/api/v1/users \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"

# Create user
curl -X POST http://localhost/api/v1/users \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"name": "John Doe", "email": "john@example.com", "password": "password123"}'

# Update user
curl -X PUT http://localhost/api/v1/users/1 \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"name": "Jane Doe", "status": "active"}'</code></pre>
            </div>

            <div class="alert alert-success">
                <i class="fas fa-check-circle me-2"></i>
                <strong>Testing Tools:</strong> Use tools like Postman, Insomnia, or curl for API testing and development.
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
</body>
</html>