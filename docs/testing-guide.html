<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Testing Guide - Framework Documentation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8f9fa; }
        .container { max-width: 1200px; }
        .page-header { border-bottom: 2px solid #667eea; padding-bottom: 1rem; margin-bottom: 2rem; }
        .page-title { color: #667eea; font-weight: 700; margin: 0; }
        .code-example { background: #2d3748; border-radius: 8px; padding: 1.5rem; margin: 1rem 0; position: relative; }
        .code-example::before { content: attr(data-title); position: absolute; top: 0; left: 0; background: #667eea; color: white; padding: 0.25rem 0.75rem; border-radius: 8px 0 8px 0; font-size: 0.75rem; font-weight: 600; }
        .toc { background: #f8f9fa; border-left: 4px solid #667eea; padding: 1rem; margin: 1rem 0; border-radius: 0 8px 8px 0; }
        .alert-info { background: linear-gradient(135deg, #e3f2fd, #bbdefb); border: 1px solid #2196f3; color: #0d47a1; }
        .alert-warning { background: linear-gradient(135deg, #fff3e0, #ffcc02); border: 1px solid #ff9800; color: #e65100; }
        .alert-success { background: linear-gradient(135deg, #e8f5e8, #c8e6c9); border: 1px solid #4caf50; color: #1b5e20; }
        .nav-pills .nav-link { margin: 0.25rem; }
        .nav-pills .nav-link.active { background-color: #667eea; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <!-- Navigation -->
        <nav class="mb-4">
            <ul class="nav nav-pills">
                <li class="nav-item"><a class="nav-link" href="index.html">Overview</a></li>
                <li class="nav-item"><a class="nav-link" href="installation-guide.html">Installation</a></li>
                <li class="nav-item"><a class="nav-link" href="mvc-guide.html">MVC</a></li>
                <li class="nav-item"><a class="nav-link" href="database-guide.html">Database</a></li>
                <li class="nav-item"><a class="nav-link" href="acl-guide.html">ACL</a></li>
                <li class="nav-item"><a class="nav-link" href="validation-guide.html">Validation</a></li>
                <li class="nav-item"><a class="nav-link" href="forms-guide.html">Forms</a></li>
                <li class="nav-item"><a class="nav-link" href="api-guide.html">API</a></li>
                <li class="nav-item"><a class="nav-link active" href="testing-guide.html">Testing</a></li>
                <li class="nav-item"><a class="nav-link" href="best-practices-guide.html">Best Practices</a></li>
            </ul>
        </nav>

        <!-- Content -->
        <div class="bg-white rounded p-4 shadow-sm">
            <div class="page-header">
                <h1 class="page-title">Testing</h1>
                <p class="page-subtitle text-muted">Unit testing, API testing, and test strategies</p>
            </div>

            <div class="toc">
                <h6>Table of Contents</h6>
                <ul>
                    <li><a href="#testing-setup">Testing Setup</a></li>
                    <li><a href="#unit-tests">Unit Tests</a></li>
                    <li><a href="#integration-tests">Integration Tests</a></li>
                    <li><a href="#api-testing">API Testing</a></li>
                    <li><a href="#database-testing">Database Testing</a></li>
                    <li><a href="#test-organization">Test Organization</a></li>
                </ul>
            </div>

            <h2 id="testing-setup">Testing Setup</h2>
            <p>Set up a comprehensive testing environment for your application.</p>

            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Testing Philosophy:</strong> Write tests that are fast, reliable, and maintainable. Focus on testing behavior, not implementation details.
            </div>

            <h3>Test Configuration</h3>
            <div class="code-example" data-title="tests/bootstrap.php">
                <pre><code class="language-php"><?php
// Bootstrap file for tests
require_once __DIR__ . '/../vendor/autoload.php';

// Set test environment
$_ENV['APP_ENV'] = 'testing';
$_ENV['DB_NAME'] = 'test_database';

// Initialize test database
$testDb = new PDO('mysql:host=localhost;dbname=test_database', 'root', '');
$testDb->exec('SET FOREIGN_KEY_CHECKS = 0');

// Base test class
abstract class TestCase
{
    protected $db;
    
    public function setUp(): void
    {
        $this->db = Container::getDefault()->get('db');
        $this->startTransaction();
    }
    
    public function tearDown(): void
    {
        $this->rollbackTransaction();
    }
    
    protected function startTransaction()
    {
        $this->db->beginTransaction();
    }
    
    protected function rollbackTransaction()
    {
        $this->db->rollback();
    }
    
    protected function assertDatabaseHas($table, $data)
    {
        $query = $this->db->table($table);
        
        foreach ($data as $key => $value) {
            $query->where($key, $value);
        }
        
        $count = $query->count();
        
        if ($count === 0) {
            throw new Exception("Failed asserting that table '{$table}' contains matching record");
        }
        
        return true;
    }
    
    protected function assertDatabaseMissing($table, $data)
    {
        $query = $this->db->table($table);
        
        foreach ($data as $key => $value) {
            $query->where($key, $value);
        }
        
        $count = $query->count();
        
        if ($count > 0) {
            throw new Exception("Failed asserting that table '{$table}' does not contain matching record");
        }
        
        return true;
    }
}</code></pre>
            </div>

            <h2 id="unit-tests">Unit Tests</h2>

            <h3>Model Testing</h3>
            <div class="code-example" data-title="tests/Models/UserTest.php">
                <pre><code class="language-php"><?php
require_once 'tests/bootstrap.php';

class UserTest extends TestCase
{
    public function testUserCreation()
    {
        $userData = [
            'name' => 'John Doe',
            'email' => 'john@example.com',
            'password' => 'password123'
        ];
        
        $user = User::create($userData);
        
        assert($user instanceof User);
        assert($user->name === 'John Doe');
        assert($user->email === 'john@example.com');
        assert(!empty($user->id));
        
        $this->assertDatabaseHas('user', [
            'name' => 'John Doe',
            'email' => 'john@example.com'
        ]);
    }
    
    public function testPasswordHashing()
    {
        $user = new User();
        $user->setPassword('password123');
        
        assert($user->password !== 'password123');
        assert(password_verify('password123', $user->password));
    }
    
    public function testUserValidation()
    {
        $validator = new Validator();
        
        // Test invalid email
        $validation = $validator->validate([
            'name' => 'John',
            'email' => 'invalid-email',
            'password' => '123'
        ], [
            'name' => 'required|min:2',
            'email' => 'required|email',
            'password' => 'required|min:8'
        ]);
        
        assert($validation->fails());
        
        $errors = $validation->errors();
        assert(isset($errors['email']));
        assert(isset($errors['password']));
    }
    
    public function testUserRoles()
    {
        $user = User::create([
            'name' => 'Test User',
            'email' => 'test@example.com',
            'password' => 'password123'
        ]);
        
        $role = Role::create(['name' => 'editor']);
        
        $user->assignRole($role);
        
        assert($user->hasRole('editor'));
        assert(!$user->hasRole('admin'));
    }
}</code></pre>
            </div>

            <h3>Service Testing</h3>
            <div class="code-example" data-title="tests/Services/EmailServiceTest.php">
                <pre><code class="language-php"><?php
class EmailServiceTest extends TestCase
{
    private $emailService;
    
    public function setUp(): void
    {
        parent::setUp();
        $this->emailService = new EmailService();
    }
    
    public function testSendWelcomeEmail()
    {
        $user = User::create([
            'name' => 'John Doe',
            'email' => 'john@example.com',
            'password' => 'password123'
        ]);
        
        $result = $this->emailService->sendWelcomeEmail($user);
        
        assert($result === true);
        
        // Verify email was queued or sent
        $this->assertDatabaseHas('email_queue', [
            'to_email' => 'john@example.com',
            'template' => 'welcome'
        ]);
    }
    
    public function testEmailValidation()
    {
        $result = $this->emailService->validateEmail('invalid-email');
        assert($result === false);
        
        $result = $this->emailService->validateEmail('valid@example.com');
        assert($result === true);
    }
}</code></pre>
            </div>

            <h2 id="integration-tests">Integration Tests</h2>

            <h3>Controller Testing</h3>
            <div class="code-example" data-title="tests/Controllers/UserControllerTest.php">
                <pre><code class="language-php"><?php
class UserControllerTest extends TestCase
{
    public function testUserRegistration()
    {
        $data = [
            'name' => 'John Doe',
            'email' => 'john@example.com',
            'password' => 'password123',
            'password_confirmation' => 'password123'
        ];
        
        // Mock request
        $_POST = $data;
        $_SERVER['REQUEST_METHOD'] = 'POST';
        
        $controller = new UserController();
        $response = $controller->store();
        
        // Check redirect response
        assert($response instanceof RedirectResponse);
        
        // Verify user was created
        $this->assertDatabaseHas('user', [
            'name' => 'John Doe',
            'email' => 'john@example.com'
        ]);
    }
    
    public function testUserLoginValidation()
    {
        $_POST = [
            'email' => 'invalid-email',
            'password' => ''
        ];
        
        $controller = new AuthController();
        $response = $controller->login();
        
        // Should redirect back with errors
        assert($response instanceof RedirectResponse);
        assert(!empty(Session::get('errors')));
    }
    
    public function testUserDeletion()
    {
        $user = User::create([
            'name' => 'Test User',
            'email' => 'test@example.com',
            'password' => 'password123'
        ]);
        
        // Mock authenticated user
        Session::set('user_id', 1); // Admin user
        
        $controller = new UserController();
        $response = $controller->destroy($user->id);
        
        $this->assertDatabaseMissing('user', ['id' => $user->id]);
    }
}</code></pre>
            </div>

            <h2 id="api-testing">API Testing</h2>

            <div class="code-example" data-title="tests/Api/UserApiTest.php">
                <pre><code class="language-php"><?php
class UserApiTest extends TestCase
{
    private $authToken;
    
    public function setUp(): void
    {
        parent::setUp();
        $this->authToken = $this->getAuthToken();
    }
    
    private function getAuthToken()
    {
        // Create test user
        $user = User::create([
            'name' => 'API Test User',
            'email' => 'api@example.com',
            'password' => password_hash('password123', PASSWORD_DEFAULT)
        ]);
        
        // Generate JWT token
        return JWT::encode([
            'user_id' => $user->id,
            'email' => $user->email,
            'exp' => time() + 3600
        ]);
    }
    
    public function testGetUsers()
    {
        $_SERVER['HTTP_AUTHORIZATION'] = 'Bearer ' . $this->authToken;
        $_SERVER['REQUEST_METHOD'] = 'GET';
        
        $controller = new Api\UserController();
        $response = $controller->index();
        
        assert($response instanceof JsonResponse);
        
        $data = json_decode($response->getContent(), true);
        assert($data['success'] === true);
        assert(isset($data['data']));
    }
    
    public function testCreateUser()
    {
        $_SERVER['HTTP_AUTHORIZATION'] = 'Bearer ' . $this->authToken;
        $_SERVER['REQUEST_METHOD'] = 'POST';
        $_POST = [
            'name' => 'New User',
            'email' => 'newuser@example.com',
            'password' => 'password123'
        ];
        
        $controller = new Api\UserController();
        $response = $controller->store();
        
        $data = json_decode($response->getContent(), true);
        assert($data['success'] === true);
        assert($response->getStatusCode() === 201);
        
        $this->assertDatabaseHas('user', [
            'name' => 'New User',
            'email' => 'newuser@example.com'
        ]);
    }
    
    public function testUnauthorizedAccess()
    {
        // No authorization header
        $_SERVER['REQUEST_METHOD'] = 'GET';
        
        $middleware = new ApiAuthMiddleware();
        $response = $middleware->handle(new Request(), function() {
            return response()->json(['success' => true]);
        });
        
        assert($response->getStatusCode() === 401);
        
        $data = json_decode($response->getContent(), true);
        assert($data['success'] === false);
    }
    
    public function testRateLimiting()
    {
        $_SERVER['HTTP_AUTHORIZATION'] = 'Bearer ' . $this->authToken;
        $_SERVER['REQUEST_METHOD'] = 'GET';
        $_SERVER['REMOTE_ADDR'] = '127.0.0.1';
        
        $controller = new Api\UserController();
        
        // Make multiple requests to trigger rate limit
        for ($i = 0; $i < 105; $i++) {
            $response = $controller->index();
        }
        
        assert($response->getStatusCode() === 429);
    }
}</code></pre>
            </div>

            <h2 id="database-testing">Database Testing</h2>

            <div class="code-example" data-title="tests/Database/QueryBuilderTest.php">
                <pre><code class="language-php"><?php
class QueryBuilderTest extends TestCase
{
    public function testBasicSelect()
    {
        // Insert test data
        $this->db->table('user')->insert([
            'name' => 'John Doe',
            'email' => 'john@example.com',
            'status' => 'active'
        ]);
        
        // Test select
        $users = $this->db->table('user')->get();
        assert(count($users) >= 1);
        
        // Test where clause
        $activeUsers = $this->db->table('user')
            ->where('status', 'active')
            ->get();
        assert(count($activeUsers) >= 1);
    }
    
    public function testJoins()
    {
        // Create test data
        $userId = $this->db->table('user')->insert([
            'name' => 'John Doe',
            'email' => 'john@example.com'
        ]);
        
        $this->db->table('user_profile')->insert([
            'user_id' => $userId,
            'bio' => 'Test bio'
        ]);
        
        // Test join
        $result = $this->db->table('user')
            ->select(['user.name', 'user_profile.bio'])
            ->join('user_profile', 'user.id', '=', 'user_profile.user_id')
            ->where('user.id', $userId)
            ->first();
            
        assert($result['name'] === 'John Doe');
        assert($result['bio'] === 'Test bio');
    }
    
    public function testTransactions()
    {
        $this->db->beginTransaction();
        
        try {
            $this->db->table('user')->insert([
                'name' => 'Transaction Test',
                'email' => 'transaction@example.com'
            ]);
            
            // Simulate error
            throw new Exception('Test error');
            
            $this->db->commit();
        } catch (Exception $e) {
            $this->db->rollback();
        }
        
        // User should not exist due to rollback
        $user = $this->db->table('user')
            ->where('email', 'transaction@example.com')
            ->first();
            
        assert($user === null);
    }
}</code></pre>
            </div>

            <h2 id="test-organization">Test Organization</h2>

            <h3>Test Runner</h3>
            <div class="code-example" data-title="run-tests.php">
                <pre><code class="language-php"><?php
require_once 'tests/bootstrap.php';

class TestRunner
{
    private $passed = 0;
    private $failed = 0;
    private $errors = [];
    
    public function run()
    {
        $testFiles = $this->getTestFiles();
        
        foreach ($testFiles as $file) {
            $this->runTestFile($file);
        }
        
        $this->printResults();
    }
    
    private function getTestFiles()
    {
        $files = [];
        $iterator = new RecursiveIteratorIterator(
            new RecursiveDirectoryIterator('tests/')
        );
        
        foreach ($iterator as $file) {
            if ($file->isFile() && str_ends_with($file->getFilename(), 'Test.php')) {
                $files[] = $file->getPathname();
            }
        }
        
        return $files;
    }
    
    private function runTestFile($file)
    {
        require_once $file;
        
        $className = basename($file, '.php');
        
        if (class_exists($className)) {
            $testClass = new $className();
            $methods = get_class_methods($testClass);
            
            foreach ($methods as $method) {
                if (str_starts_with($method, 'test')) {
                    $this->runTest($testClass, $method);
                }
            }
        }
    }
    
    private function runTest($testClass, $method)
    {
        try {
            if (method_exists($testClass, 'setUp')) {
                $testClass->setUp();
            }
            
            $testClass->$method();
            
            if (method_exists($testClass, 'tearDown')) {
                $testClass->tearDown();
            }
            
            $this->passed++;
            echo ".";
        } catch (Exception $e) {
            $this->failed++;
            $this->errors[] = [
                'class' => get_class($testClass),
                'method' => $method,
                'error' => $e->getMessage()
            ];
            echo "F";
        }
    }
    
    private function printResults()
    {
        echo "\n\n";
        echo "Tests run: " . ($this->passed + $this->failed) . "\n";
        echo "Passed: " . $this->passed . "\n";
        echo "Failed: " . $this->failed . "\n";
        
        if (!empty($this->errors)) {
            echo "\nFailures:\n";
            foreach ($this->errors as $error) {
                echo "- {$error['class']}::{$error['method']}: {$error['error']}\n";
            }
        }
    }
}

// Run tests
$runner = new TestRunner();
$runner->run();</code></pre>
            </div>

            <div class="alert alert-success">
                <i class="fas fa-check-circle me-2"></i>
                <strong>Testing Best Practices:</strong> Write tests first (TDD), keep tests simple and focused, use descriptive test names, and maintain good test coverage.
            </div>

            <h3>Running Tests</h3>
            <div class="code-example" data-title="Command Line">
                <pre><code class="language-bash"># Run all tests
php run-tests.php

# Run specific test file
php tests/Models/UserTest.php

# Run with coverage (if Xdebug is installed)
php -d xdebug.mode=coverage run-tests.php</code></pre>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
</body>
</html>