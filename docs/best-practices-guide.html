<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Best Practices Guide - Framework Documentation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8f9fa; }
        .container { max-width: 1200px; }
        .page-header { border-bottom: 2px solid #667eea; padding-bottom: 1rem; margin-bottom: 2rem; }
        .page-title { color: #667eea; font-weight: 700; margin: 0; }
        .code-example { background: #2d3748; border-radius: 8px; padding: 1.5rem; margin: 1rem 0; position: relative; }
        .code-example::before { content: attr(data-title); position: absolute; top: 0; left: 0; background: #667eea; color: white; padding: 0.25rem 0.75rem; border-radius: 8px 0 8px 0; font-size: 0.75rem; font-weight: 600; }
        .toc { background: #f8f9fa; border-left: 4px solid #667eea; padding: 1rem; margin: 1rem 0; border-radius: 0 8px 8px 0; }
        .alert-info { background: linear-gradient(135deg, #e3f2fd, #bbdefb); border: 1px solid #2196f3; color: #0d47a1; }
        .alert-warning { background: linear-gradient(135deg, #fff3e0, #ffcc02); border: 1px solid #ff9800; color: #e65100; }
        .alert-success { background: linear-gradient(135deg, #e8f5e8, #c8e6c9); border: 1px solid #4caf50; color: #1b5e20; }
        .alert-danger { background: linear-gradient(135deg, #ffebee, #ffcdd2); border: 1px solid #f44336; color: #b71c1c; }
        .nav-pills .nav-link { margin: 0.25rem; }
        .nav-pills .nav-link.active { background-color: #667eea; }
        .best-practice { border-left: 4px solid #28a745; background: #f8fff9; padding: 1rem; margin: 1rem 0; }
        .security-tip { border-left: 4px solid #dc3545; background: #fff8f8; padding: 1rem; margin: 1rem 0; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <!-- Navigation -->
        <nav class="mb-4">
            <ul class="nav nav-pills">
                <li class="nav-item"><a class="nav-link" href="index.html">Overview</a></li>
                <li class="nav-item"><a class="nav-link" href="installation-guide.html">Installation</a></li>
                <li class="nav-item"><a class="nav-link" href="mvc-guide.html">MVC</a></li>
                <li class="nav-item"><a class="nav-link" href="database-guide.html">Database</a></li>
                <li class="nav-item"><a class="nav-link" href="acl-guide.html">ACL</a></li>
                <li class="nav-item"><a class="nav-link" href="validation-guide.html">Validation</a></li>
                <li class="nav-item"><a class="nav-link" href="forms-guide.html">Forms</a></li>
                <li class="nav-item"><a class="nav-link" href="api-guide.html">API</a></li>
                <li class="nav-item"><a class="nav-link" href="testing-guide.html">Testing</a></li>
                <li class="nav-item"><a class="nav-link active" href="best-practices-guide.html">Best Practices</a></li>
            </ul>
        </nav>

        <!-- Content -->
        <div class="bg-white rounded p-4 shadow-sm">
            <div class="page-header">
                <h1 class="page-title">Best Practices</h1>
                <p class="page-subtitle text-muted">Security guidelines, code organization, and performance tips</p>
            </div>

            <div class="toc">
                <h6>Table of Contents</h6>
                <ul>
                    <li><a href="#security">Security Best Practices</a></li>
                    <li><a href="#code-organization">Code Organization</a></li>
                    <li><a href="#performance">Performance Optimization</a></li>
                    <li><a href="#database-best-practices">Database Best Practices</a></li>
                    <li><a href="#error-handling">Error Handling</a></li>
                    <li><a href="#deployment">Deployment Guidelines</a></li>
                </ul>
            </div>

            <h2 id="security">Security Best Practices</h2>

            <div class="alert alert-danger">
                <i class="fas fa-shield-alt me-2"></i>
                <strong>Critical:</strong> Security should be built into your application from the ground up, not added as an afterthought.
            </div>

            <h3>Input Security</h3>
            <div class="security-tip">
                <h5><i class="fas fa-exclamation-triangle me-2"></i>Always Validate and Sanitize Input</h5>
                <p>Never trust user input. Always validate on the server side and sanitize data before processing.</p>
            </div>

            <div class="code-example" data-title="Secure Input Handling">
                <pre><code class="language-php"><?php
class SecureController extends Controller
{
    public function store()
    {
        // 1. Validate input
        $validator = new Validator();
        $validation = $validator->validate($_POST, [
            'name' => 'required|min:2|max:50|alpha_spaces',
            'email' => 'required|email|unique:user,email',
            'content' => 'required|max:1000'
        ]);
        
        if ($validation->fails()) {
            return redirect()->back()->withErrors($validation->errors());
        }
        
        // 2. Sanitize input
        $data = $validation->validated();
        $data['name'] = strip_tags(trim($data['name']));
        $data['email'] = filter_var($data['email'], FILTER_SANITIZE_EMAIL);
        $data['content'] = htmlspecialchars($data['content'], ENT_QUOTES, 'UTF-8');
        
        // 3. Use parameterized queries
        $user = User::create($data);
        
        return redirect('/users');
    }
}

// Custom validation rule for alpha with spaces
$validator->addRule('alpha_spaces', function($value) {
    return preg_match('/^[a-zA-Z\s]+$/', $value);
}, 'Field may only contain letters and spaces');</code></pre>
            </div>

            <h3>SQL Injection Prevention</h3>
            <div class="code-example" data-title="Safe Database Queries">
                <pre><code class="language-php"><?php
// ❌ NEVER do this - vulnerable to SQL injection
$unsafe = "SELECT * FROM user WHERE email = '" . $_POST['email'] . "'";
$db->query($unsafe);

// ✅ Always use parameterized queries
$safe = $db->table('user')->where('email', $_POST['email'])->get();

// ✅ Or use prepared statements
$stmt = $pdo->prepare("SELECT * FROM user WHERE email = ? AND status = ?");
$stmt->execute([$_POST['email'], 'active']);

// ✅ Query builder is safe
$users = $db->table('user')
    ->where('email', $_POST['email'])
    ->where('status', 'active')
    ->get();</code></pre>
            </div>

            <h3>XSS Prevention</h3>
            <div class="code-example" data-title="Output Escaping">
                <pre><code class="language-php"><?php
// ❌ Dangerous - raw output
echo $user->bio;

// ✅ Safe - escaped output
echo htmlspecialchars($user->bio, ENT_QUOTES, 'UTF-8');

// ✅ Helper function
function e($string) {
    return htmlspecialchars($string, ENT_QUOTES, 'UTF-8');
}

echo e($user->bio);

// In views
?>
&lt;p&gt;&lt;?= e($user->bio) ?&gt;&lt;/p&gt;
&lt;input type="text" value="&lt;?= e($user->name) ?&gt;"&gt;</code></pre>
            </div>

            <h3>Password Security</h3>
            <div class="code-example" data-title="Secure Password Handling">
                <pre><code class="language-php"><?php
class UserSecurity
{
    public static function hashPassword($password)
    {
        // Use PHP's password_hash with default algorithm
        return password_hash($password, PASSWORD_DEFAULT);
    }
    
    public static function verifyPassword($password, $hash)
    {
        return password_verify($password, $hash);
    }
    
    public static function needsRehash($hash)
    {
        // Check if password needs rehashing (algorithm updates)
        return password_needs_rehash($hash, PASSWORD_DEFAULT);
    }
    
    public static function generateSecureToken($length = 32)
    {
        return bin2hex(random_bytes($length));
    }
    
    public static function isStrongPassword($password)
    {
        // At least 8 characters, uppercase, lowercase, number, special char
        return preg_match('/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/', $password);
    }
}</code></pre>
            </div>

            <h2 id="code-organization">Code Organization</h2>

            <div class="best-practice">
                <h5><i class="fas fa-check-circle me-2"></i>Follow SOLID Principles</h5>
                <p>Write clean, maintainable code by following Single Responsibility, Open/Closed, Liskov Substitution, Interface Segregation, and Dependency Inversion principles.</p>
            </div>

            <h3>Directory Structure</h3>
            <div class="code-example" data-title="Recommended Project Structure">
                <pre><code class="language-text">app/
├── Controllers/
│   ├── Api/
│   └── Web/
├── Models/
├── Services/
├── Middleware/
├── Requests/
├── Responses/
└── Helpers/

config/
├── database.php
├── app.php
├── cache.php
└── mail.php

public/
├── index.php
├── assets/
└── uploads/

resources/
├── views/
├── css/
└── js/

storage/
├── logs/
├── cache/
└── sessions/

tests/
├── Unit/
├── Integration/
└── Api/</code></pre>
            </div>

            <h3>Naming Conventions</h3>
            <div class="code-example" data-title="Consistent Naming">
                <pre><code class="language-php"><?php
// Classes: PascalCase
class UserController extends Controller
class EmailService
class DatabaseConnection

// Methods and variables: camelCase
public function getUserById($userId)
{
    $currentUser = $this->getCurrentUser();
    $isValid = $this->validateUser($currentUser);
}

// Constants: SCREAMING_SNAKE_CASE
const MAX_LOGIN_ATTEMPTS = 5;
const SESSION_TIMEOUT = 3600;

// Database tables: snake_case
user_profiles
blog_posts
user_role_permissions

// Files: snake_case or kebab-case
user_controller.php
email-service.php
create-users-table.sql</code></pre>
            </div>

            <h3>Service Layer Pattern</h3>
            <div class="code-example" data-title="Service Organization">
                <pre><code class="language-php"><?php
// Service for business logic
class UserService
{
    private $userModel;
    private $emailService;
    
    public function __construct(User $userModel, EmailService $emailService)
    {
        $this->userModel = $userModel;
        $this->emailService = $emailService;
    }
    
    public function createUser($userData)
    {
        // Validate business rules
        if ($this->isEmailTaken($userData['email'])) {
            throw new BusinessException('Email already exists');
        }
        
        // Create user
        $user = $this->userModel->create([
            'name' => $userData['name'],
            'email' => $userData['email'],
            'password' => UserSecurity::hashPassword($userData['password'])
        ]);
        
        // Send welcome email
        $this->emailService->sendWelcomeEmail($user);
        
        // Log activity
        ActivityLog::create([
            'user_id' => $user->id,
            'action' => 'user_created',
            'ip_address' => $_SERVER['REMOTE_ADDR']
        ]);
        
        return $user;
    }
    
    private function isEmailTaken($email)
    {
        return $this->userModel->where('email', $email)->exists();
    }
}

// Thin controller using service
class UserController extends Controller
{
    private $userService;
    
    public function __construct(UserService $userService)
    {
        $this->userService = $userService;
    }
    
    public function store()
    {
        try {
            $user = $this->userService->createUser($_POST);
            return redirect('/users')->with('success', 'User created successfully');
        } catch (BusinessException $e) {
            return redirect()->back()->with('error', $e->getMessage());
        }
    }
}</code></pre>
            </div>

            <h2 id="performance">Performance Optimization</h2>

            <h3>Database Performance</h3>
            <div class="code-example" data-title="Query Optimization">
                <pre><code class="language-php"><?php
class OptimizedQueries
{
    // ❌ N+1 Query Problem
    public function getBadUserPosts()
    {
        $users = User::all();
        foreach ($users as $user) {
            $posts = Post::where('user_id', $user->id)->get(); // N queries
        }
    }
    
    // ✅ Eager Loading
    public function getGoodUserPosts()
    {
        $users = User::with('posts')->get(); // 2 queries total
    }
    
    // ✅ Use indexes for frequently queried columns
    public function createIndexes()
    {
        // In migration
        $sql = "
            CREATE INDEX idx_user_email ON user(email);
            CREATE INDEX idx_post_user_id ON post(user_id);
            CREATE INDEX idx_post_created_at ON post(created_at);
            CREATE COMPOSITE INDEX idx_post_user_status ON post(user_id, status);
        ";
    }
    
    // ✅ Paginate large result sets
    public function getPaginatedUsers()
    {
        return User::query()
            ->where('status', 'active')
            ->orderBy('created_at', 'desc')
            ->paginate(20); // Limit results
    }
    
    // ✅ Use specific columns instead of SELECT *
    public function getSelectedColumns()
    {
        return User::select(['id', 'name', 'email'])
            ->where('status', 'active')
            ->get();
    }
}</code></pre>
            </div>

            <h3>Caching Strategy</h3>
            <div class="code-example" data-title="Effective Caching">
                <pre><code class="language-php"><?php
class CacheService
{
    private $cache;
    
    public function __construct()
    {
        $this->cache = new Cache(); // Redis, Memcached, or file cache
    }
    
    public function getUserStats($userId)
    {
        $cacheKey = "user_stats_{$userId}";
        
        // Try cache first
        $stats = $this->cache->get($cacheKey);
        
        if ($stats === null) {
            // Generate stats (expensive operation)
            $stats = $this->calculateUserStats($userId);
            
            // Cache for 1 hour
            $this->cache->set($cacheKey, $stats, 3600);
        }
        
        return $stats;
    }
    
    public function invalidateUserCache($userId)
    {
        $patterns = [
            "user_stats_{$userId}",
            "user_posts_{$userId}",
            "user_profile_{$userId}"
        ];
        
        foreach ($patterns as $pattern) {
            $this->cache->delete($pattern);
        }
    }
    
    // Fragment caching for views
    public function cacheView($key, $callback, $ttl = 3600)
    {
        $content = $this->cache->get($key);
        
        if ($content === null) {
            ob_start();
            $callback();
            $content = ob_get_clean();
            
            $this->cache->set($key, $content, $ttl);
        }
        
        echo $content;
    }
}</code></pre>
            </div>

            <h2 id="database-best-practices">Database Best Practices</h2>

            <h3>Schema Design</h3>
            <div class="code-example" data-title="Good Schema Practices">
                <pre><code class="language-sql">-- ✅ Proper data types and constraints
CREATE TABLE user (
    id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(255) NOT NULL UNIQUE,
    email_verified_at TIMESTAMP NULL,
    password VARCHAR(255) NOT NULL,
    status ENUM('active', 'inactive', 'suspended') DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_email (email),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at)
);

-- ✅ Foreign key constraints
CREATE TABLE post (
    id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    user_id INT UNSIGNED NOT NULL,
    title VARCHAR(255) NOT NULL,
    content TEXT,
    status ENUM('draft', 'published', 'archived') DEFAULT 'draft',
    published_at TIMESTAMP NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (user_id) REFERENCES user(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_status (status),
    INDEX idx_published_at (published_at)
);</code></pre>
            </div>

            <h3>Migration Best Practices</h3>
            <div class="code-example" data-title="Safe Migrations">
                <pre><code class="language-php"><?php
class CreateUsersTable
{
    public function up()
    {
        // Use transactions for complex migrations
        Database::beginTransaction();
        
        try {
            $sql = "
                CREATE TABLE user (
                    id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
                    name VARCHAR(100) NOT NULL,
                    email VARCHAR(255) NOT NULL UNIQUE,
                    password VARCHAR(255) NOT NULL,
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                )
            ";
            
            Database::execute($sql);
            
            // Add indexes
            Database::execute("CREATE INDEX idx_email ON user(email)");
            Database::execute("CREATE INDEX idx_created_at ON user(created_at)");
            
            Database::commit();
        } catch (Exception $e) {
            Database::rollback();
            throw $e;
        }
    }
    
    public function down()
    {
        // Always provide rollback
        Database::execute("DROP TABLE IF EXISTS user");
    }
}

// Migration runner with backup
class MigrationRunner
{
    public function runMigration($migration)
    {
        // Create backup before migration
        $this->createBackup();
        
        try {
            $migration->up();
            $this->logMigration($migration);
        } catch (Exception $e) {
            $this->restoreBackup();
            throw $e;
        }
    }
}</code></pre>
            </div>

            <h2 id="error-handling">Error Handling</h2>

            <div class="code-example" data-title="Comprehensive Error Handling">
                <pre><code class="language-php"><?php
class ErrorHandler
{
    public static function register()
    {
        set_error_handler([self::class, 'handleError']);
        set_exception_handler([self::class, 'handleException']);
        register_shutdown_function([self::class, 'handleShutdown']);
    }
    
    public static function handleError($severity, $message, $file, $line)
    {
        if (!(error_reporting() & $severity)) {
            return false;
        }
        
        $error = [
            'type' => 'Error',
            'severity' => $severity,
            'message' => $message,
            'file' => $file,
            'line' => $line,
            'trace' => debug_backtrace()
        ];
        
        self::logError($error);
        
        if (self::isProduction()) {
            // Show user-friendly error page
            self::showErrorPage(500);
        } else {
            // Show detailed error for development
            self::showDetailedError($error);
        }
    }
    
    public static function handleException($exception)
    {
        $error = [
            'type' => 'Exception',
            'class' => get_class($exception),
            'message' => $exception->getMessage(),
            'file' => $exception->getFile(),
            'line' => $exception->getLine(),
            'trace' => $exception->getTrace()
        ];
        
        self::logError($error);
        
        if ($exception instanceof ValidationException) {
            // Handle validation errors
            redirect()->back()->withErrors($exception->getErrors());
        } elseif ($exception instanceof AuthException) {
            // Handle auth errors
            redirect('/login');
        } else {
            // Generic error handling
            self::showErrorPage(500);
        }
    }
    
    private static function logError($error)
    {
        $logMessage = sprintf(
            "[%s] %s: %s in %s:%d\n%s\n",
            date('Y-m-d H:i:s'),
            $error['type'],
            $error['message'],
            $error['file'],
            $error['line'],
            print_r($error['trace'], true)
        );
        
        file_put_contents('storage/logs/error.log', $logMessage, FILE_APPEND);
        
        // Send critical errors to monitoring service
        if (self::isCriticalError($error)) {
            self::notifyAdmin($error);
        }
    }
}</code></pre>
            </div>

            <h2 id="deployment">Deployment Guidelines</h2>

            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Deployment:</strong> Always test thoroughly in a staging environment before deploying to production.
            </div>

            <h3>Production Checklist</h3>
            <div class="best-practice">
                <h5><i class="fas fa-check-circle me-2"></i>Pre-deployment Checklist</h5>
                <ul>
                    <li>✅ All tests passing</li>
                    <li>✅ Database migrations tested</li>
                    <li>✅ Environment variables configured</li>
                    <li>✅ SSL certificates installed</li>
                    <li>✅ Error reporting disabled</li>
                    <li>✅ Logging configured</li>
                    <li>✅ Backups scheduled</li>
                    <li>✅ Monitoring setup</li>
                </ul>
            </div>

            <div class="code-example" data-title="Production Configuration">
                <pre><code class="language-php"><?php
// config/production.php
return [
    'app' => [
        'debug' => false,
        'log_level' => 'error',
        'timezone' => 'UTC'
    ],
    
    'database' => [
        'host' => $_ENV['DB_HOST'],
        'database' => $_ENV['DB_NAME'],
        'username' => $_ENV['DB_USER'],
        'password' => $_ENV['DB_PASS'],
        'charset' => 'utf8mb4',
        'options' => [
            PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
            PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
            PDO::ATTR_PERSISTENT => true, // Connection pooling
        ]
    ],
    
    'cache' => [
        'driver' => 'redis',
        'host' => $_ENV['REDIS_HOST'],
        'port' => $_ENV['REDIS_PORT'],
        'ttl' => 3600
    ],
    
    'security' => [
        'csrf_token' => true,
        'session_secure' => true,
        'session_httponly' => true,
        'force_https' => true
    ]
];</code></pre>
            </div>

            <div class="alert alert-success">
                <i class="fas fa-check-circle me-2"></i>
                <strong>Remember:</strong> Security, performance, and maintainability should be considered throughout the development process, not just at the end.
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
</body>
</html>