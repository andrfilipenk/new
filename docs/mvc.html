<section id="mvc" class="content-section active">
    <div class="page-header">
        <h1 class="page-title">MVC Architecture</h1>
        <p class="page-subtitle">Understanding the Model-View-Controller pattern in our framework</p>
    </div>

    <div class="toc">
        <h6>Table of Contents</h6>
        <ul>
            <li><a href="#mvc-overview">MVC Overview</a></li>
            <li><a href="#models">Models</a></li>
            <li><a href="#views">Views</a></li>
            <li><a href="#controllers">Controllers</a></li>
            <li><a href="#routing">Routing</a></li>
            <li><a href="#modules">Modules</a></li>
        </ul>
    </div>

    <h2 id="mvc-overview">MVC Overview</h2>
    <p>The framework follows the Model-View-Controller (MVC) architectural pattern, which separates application logic into three interconnected components:</p>

    <div class="feature-grid">
        <div class="feature-card">
            <div class="feature-icon">
                <i class="fas fa-database"></i>
            </div>
            <h5>Model</h5>
            <p>Manages data and business logic. Handles database operations, validation, and data relationships.</p>
        </div>

        <div class="feature-card">
            <div class="feature-icon">
                <i class="fas fa-eye"></i>
            </div>
            <h5>View</h5>
            <p>Handles the presentation layer. Renders HTML templates and manages user interface components.</p>
        </div>

        <div class="feature-card">
            <div class="feature-icon">
                <i class="fas fa-cogs"></i>
            </div>
            <h5>Controller</h5>
            <p>Coordinates between Model and View. Handles user input, processes requests, and manages application flow.</p>
        </div>
    </div>

    <h2 id="models">Models</h2>
    <p>Models represent data structures and business logic. They extend the base Model class and provide ORM functionality.</p>

    <h3>Basic Model Example</h3>
    <div class="code-example" data-title="app/Admin/Model/User.php">
        <pre><code class="language-php"><?php
namespace Admin\Model;

use Core\Database\Model;

class User extends Model
{
    // Table name (optional - auto-detected from class name)
    protected $table = 'user';
    
    // Primary key (default: 'id')
    protected $primaryKey = 'id';
    
    // Fillable attributes for mass assignment
    protected array $fillable = [
        'name', 'email', 'password', 'custom_id', 
        'first_name', 'last_name', 'phone', 'department'
    ];
    
    // Hidden attributes (not included in JSON/array output)
    protected array $hidden = ['password'];
    
    // Automatic timestamps (created_at, updated_at)
    protected $timestamps = true;
    
    /**
     * Hash password before saving
     */
    public function save(): bool
    {
        if (isset($this->attributes['password']) && $this->isDirty('password')) {
            $config = Container::getDefault()->get('config');
            $this->attributes['password'] = password_hash(
                $this->attributes['password'], 
                $config['app']['hash_algo']
            );
        }
        return parent::save();
    }
    
    /**
     * Verify password
     */
    public function verifyPassword(string $password): bool
    {
        return password_verify($password, $this->attributes['password']);
    }
    
    /**
     * Check if attribute has changed
     */
    protected function isDirty(string $attribute): bool
    {
        return !isset($this->original[$attribute]) || 
               $this->attributes[$attribute] !== $this->original[$attribute];
    }
}</code></pre>
    </div>

    <h3>Model Relationships</h3>
    <div class="code-example" data-title="Defining Relationships">
        <pre><code class="language-php"><?php
class User extends Model
{
    /**
     * One-to-Many: User has many tasks
     */
    public function createdTasks()
    {
        return $this->hasMany(Task::class, 'created_by', 'id');
    }
    
    /**
     * Many-to-Many: User belongs to many groups
     */
    public function groups()
    {
        return $this->belongsToMany(Groups::class, 'user_group', 'user_id', 'group_id');
    }
    
    /**
     * Many-to-Many: User has many roles (ACL)
     */
    public function roles()
    {
        return $this->belongsToMany(Role::class, 'acl_user_role', 'user_id', 'role_id');
    }
    
    /**
     * One-to-One: User has one profile
     */
    public function profile()
    {
        return $this->hasOne(UserProfile::class, 'user_id', 'id');
    }
    
    /**
     * Self-referencing: User has manager
     */
    public function manager()
    {
        return $this->belongsTo(User::class, 'manager_id', 'id');
    }
    
    /**
     * Self-referencing: User has subordinates
     */
    public function subordinates()
    {
        return $this->hasMany(User::class, 'manager_id', 'id');
    }
}</code></pre>
    </div>

    <h3>Model Usage Examples</h3>
    <div class="code-example" data-title="Basic CRUD Operations">
        <pre><code class="language-php"><?php
// Create new user
$user = new User();
$user->name = 'John Doe';
$user->email = 'john@example.com';
$user->password = 'password123';
$user->save();

// Or using mass assignment
$user = User::create([
    'name' => 'Jane Smith',
    'email' => 'jane@example.com',
    'password' => 'password123'
]);

// Find user by ID
$user = User::find(1);

// Find user by custom field
$user = User::find('john@example.com', 'email');

// Update user
$user = User::find(1);
$user->name = 'John Updated';
$user->save();

// Delete user
$user = User::find(1);
$user->delete();

// Query with conditions
$users = User::where('department', 'IT')
             ->where('status', 'active')
             ->orderBy('name')
             ->get();

// Query with relationships
$users = User::with(['groups', 'roles'])->get();

// Count records
$activeUsers = User::where('status', 'active')->count();</code></pre>
    </div>

    <h2 id="views">Views</h2>
    <p>Views handle the presentation layer using PHP templates with a simple but powerful template system.</p>

    <h3>View Structure</h3>
    <div class="code-example" data-title="app/Admin/views/user/index.phtml">
        <pre><code class="language-php"><?php $this->setLayout('default'); ?>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>User Management</h1>
                <a href="<?= $this->url('admin/user/create') ?>" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Add User
                </a>
            </div>

            <?php if (!empty($users)): ?>
                <div class="card">
                    <div class="card-body">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Department</th>
                                    <th>Status</th>
                                    <th>Groups</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php foreach ($users as $user): ?>
                                    <tr>
                                        <td><?= $this->escape($user->id) ?></td>
                                        <td><?= $this->escape($user->name) ?></td>
                                        <td><?= $this->escape($user->email) ?></td>
                                        <td><?= $this->escape($user->department ?? '-') ?></td>
                                        <td>
                                            <span class="badge bg-<?= $user->status === 'active' ? 'success' : 'secondary' ?>">
                                                <?= ucfirst($user->status) ?>
                                            </span>
                                        </td>
                                        <td>
                                            <?php if (count($user->groups) > 0): ?>
                                                <?php foreach ($user->groups as $group): ?>
                                                    <span class="badge bg-info me-1"><?= $this->escape($group->name) ?></span>
                                                <?php endforeach; ?>
                                            <?php else: ?>
                                                <span class="text-muted">No groups</span>
                                            <?php endif; ?>
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <a href="<?= $this->url('admin/user/view/' . $user->id) ?>" 
                                                   class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <a href="<?= $this->url('admin/user/edit/' . $user->id) ?>" 
                                                   class="btn btn-sm btn-outline-warning">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                <a href="<?= $this->url('admin/user/delete/' . $user->id) ?>" 
                                                   class="btn btn-sm btn-outline-danger"
                                                   onclick="return confirm('Are you sure?')">
                                                    <i class="fas fa-trash"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                <?php endforeach; ?>
                            </tbody>
                        </table>
                    </div>
                </div>
            <?php else: ?>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    No users found. <a href="<?= $this->url('admin/user/create') ?>">Create the first user</a>.
                </div>
            <?php endif; ?>
        </div>
    </div>
</div></code></pre>
    </div>

    <h3>Layout Templates</h3>
    <div class="code-example" data-title="app/Admin/views/layouts/default.phtml">
        <pre><code class="language-php"><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?= $this->escape($title ?? 'Admin Panel') ?></title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="<?= $this->url('css/admin.css') ?>">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="<?= $this->url('admin') ?>">
                <i class="fas fa-cog me-2"></i>Admin Panel
            </a>
            
            <div class="navbar-nav ms-auto">
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user"></i> <?= $this->escape($user['name'] ?? 'Admin') ?>
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="<?= $this->url('admin/profile') ?>">Profile</a></li>
                        <li><a class="dropdown-item" href="<?= $this->url('admin/settings') ?>">Settings</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="<?= $this->url('logout') ?>">Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <!-- Flash Messages -->
    <?php if ($this->hasFlashMessages()): ?>
        <div class="container-fluid mt-3">
            <?php foreach ($this->getFlashMessages() as $message): ?>
                <div class="alert alert-<?= $message['type'] ?> alert-dismissible fade show" role="alert">
                    <?= $this->escape($message['message']) ?>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            <?php endforeach; ?>
        </div>
    <?php endif; ?>

    <!-- Main Content -->
    <main class="container-fluid mt-4">
        <?= $this->getContent() ?>
    </main>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="<?= $this->url('js/admin.js') ?>"></script>
</body>
</html></code></pre>
    </div>

    <h2 id="controllers">Controllers</h2>
    <p>Controllers handle user input, coordinate between models and views, and manage application flow.</p>

    <h3>Basic Controller</h3>
    <div class="code-example" data-title="app/Admin/Controller/User.php">
        <pre><code class="language-php"><?php
namespace Admin\Controller;

use Core\Mvc\Controller;
use Admin\Model\User as UserModel;
use Admin\Model\Groups as GroupModel;

class User extends Controller
{
    /**
     * List all users
     */
    public function indexAction()
    {
        // Get users with their groups
        $users = UserModel::with(['groups'])->get();
        
        return $this->render('user/index', [
            'users' => $users,
            'title' => 'User Management'
        ]);
    }

    /**
     * Show user details
     */
    public function viewAction()
    {
        $id = $this->getDispatcher()->getParam('id');
        $user = UserModel::with(['groups', 'roles'])->find($id);
        
        if (!$user) {
            $this->flashError('User not found.');
            return $this->redirect('admin/user');
        }
        
        $allGroups = GroupModel::all();
        
        return $this->render('user/view', [
            'user' => $user,
            'allGroups' => $allGroups,
            'title' => 'User Details - ' . $user->name
        ]);
    }

    /**
     * Create new user
     */
    public function createAction()
    {
        if ($this->isPost()) {
            $data = $this->getRequest()->all();
            
            // Validate input
            $validation = $this->validateUserData($data);
            if (!$validation['valid']) {
                $this->flashError('Validation failed: ' . implode(', ', $validation['errors']));
                return $this->render('user/form', ['data' => $data]);
            }
            
            // Create user
            $user = new UserModel();
            $user->fill($data);
            
            if ($user->save()) {
                $this->flashSuccess('User created successfully.');
                return $this->redirect('admin/user/view/' . $user->id);
            } else {
                $this->flashError('Failed to create user.');
            }
        }
        
        return $this->render('user/form', [
            'title' => 'Create User'
        ]);
    }

    /**
     * Edit user
     */
    public function editAction()
    {
        $id = $this->getDispatcher()->getParam('id');
        $user = UserModel::find($id);
        
        if (!$user) {
            $this->flashError('User not found.');
            return $this->redirect('admin/user');
        }
        
        if ($this->isPost()) {
            $data = $this->getRequest()->all();
            
            // Validate input
            $validation = $this->validateUserData($data, $user->id);
            if (!$validation['valid']) {
                $this->flashError('Validation failed: ' . implode(', ', $validation['errors']));
                return $this->render('user/form', ['user' => $user, 'data' => $data]);
            }
            
            // Update user
            $user->fill($data);
            
            if ($user->save()) {
                $this->flashSuccess('User updated successfully.');
                return $this->redirect('admin/user/view/' . $user->id);
            } else {
                $this->flashError('Failed to update user.');
            }
        }
        
        return $this->render('user/form', [
            'user' => $user,
            'title' => 'Edit User - ' . $user->name
        ]);
    }

    /**
     * Delete user
     */
    public function deleteAction()
    {
        $id = $this->getDispatcher()->getParam('id');
        $user = UserModel::find($id);
        
        if ($user) {
            // Remove relationships first
            $user->groups()->detach();
            $user->roles()->detach();
            
            if ($user->delete()) {
                $this->flashSuccess('User deleted successfully.');
            } else {
                $this->flashError('Failed to delete user.');
            }
        } else {
            $this->flashError('User not found.');
        }
        
        return $this->redirect('admin/user');
    }

    /**
     * Validate user data
     */
    protected function validateUserData(array $data, int $excludeId = null): array
    {
        $errors = [];
        
        // Required fields
        if (empty($data['name'])) {
            $errors[] = 'Name is required';
        }
        
        if (empty($data['email'])) {
            $errors[] = 'Email is required';
        } elseif (!filter_var($data['email'], FILTER_VALIDATE_EMAIL)) {
            $errors[] = 'Valid email is required';
        } else {
            // Check for duplicate email
            $query = UserModel::where('email', $data['email']);
            if ($excludeId) {
                $query->where('id', '!=', $excludeId);
            }
            if ($query->count() > 0) {
                $errors[] = 'Email already exists';
            }
        }
        
        if (empty($data['custom_id'])) {
            $errors[] = 'Custom ID is required';
        } else {
            // Check for duplicate custom_id
            $query = UserModel::where('custom_id', $data['custom_id']);
            if ($excludeId) {
                $query->where('id', '!=', $excludeId);
            }
            if ($query->count() > 0) {
                $errors[] = 'Custom ID already exists';
            }
        }
        
        return [
            'valid' => empty($errors),
            'errors' => $errors
        ];
    }
}</code></pre>
    </div>

    <h3>Controller Helpers</h3>
    <div class="code-example" data-title="Common Controller Methods">
        <pre><code class="language-php"><?php
// Base controller methods available in all controllers

// Request handling
$this->isPost()                    // Check if POST request
$this->isAjax()                    // Check if AJAX request
$this->getPost('field', 'default') // Get POST data
$this->getRequest()->all()         // Get all request data

// Response methods
$this->render('template', $data)   // Render view template
$this->redirect('route')           // Redirect to route
$this->jsonResponse($data)         // Return JSON response

// Flash messages
$this->flashSuccess('Message')     // Success message
$this->flashError('Message')       // Error message
$this->flashWarning('Message')     // Warning message
$this->flashInfo('Message')        // Info message

// Services access
$this->getDI()->get('service')     // Get service from container
$this->getSession()                // Get session service
$this->getDispatcher()             // Get dispatcher
$this->url('route')                // Generate URL</code></pre>
    </div>

    <h2 id="routing">Routing</h2>
    <p>The framework uses a simple but powerful routing system based on the Module/Controller/Action pattern.</p>

    <h3>Route Structure</h3>
    <div class="code-example" data-title="Route Pattern">
        <pre><code class="language-text"># Basic route pattern:
/{module}/{controller}/{action}/{params}

# Examples:
/admin/user/view/123        # Admin module, User controller, view action, ID 123
/base/auth/login            # Base module, Auth controller, login action
/api/user                   # Api module, User controller, index action (default)</code></pre>
    </div>

    <h3>URL Generation</h3>
    <div class="code-example" data-title="Generating URLs">
        <pre><code class="language-php"><?php
// In controllers
$url = $this->url('admin/user/view/123');

// In views
$url = $this->url('admin/user/create');

// With parameters
$editUrl = $this->url('admin/user/edit/' . $user->id);

// External URLs
$fullUrl = $this->url('admin/user', true); // With domain</code></pre>
    </div>

    <h2 id="modules">Modules</h2>
    <p>The framework is organized into modules, each containing its own controllers, models, and views.</p>

    <h3>Module Structure</h3>
    <div class="code-example" data-title="Module Directory Structure">
        <pre><code class="language-text">app/
├── _Core/                 # Core framework components
├── Admin/                 # Admin module
│   ├── Controller/        # Admin controllers
│   ├── Model/             # Admin models
│   ├── views/             # Admin view templates
│   └── Form/              # Admin forms
├── Base/                  # Base module (public area)
│   ├── Controller/
│   ├── Model/
│   └── views/
└── Api/                   # API module
    ├── Controller/
    └── Model/</code></pre>
    </div>

    <h3>Creating a New Module</h3>
    <div class="code-example" data-title="Module Configuration">
        <pre><code class="language-php"><?php
// config/app.php
return [
    'modules' => [
        'Base' => [
            'path' => APP_PATH . 'Base/',
            'namespace' => 'Base\\'
        ],
        'Admin' => [
            'path' => APP_PATH . 'Admin/',
            'namespace' => 'Admin\\'
        ],
        'Reports' => [  // New module
            'path' => APP_PATH . 'Reports/',
            'namespace' => 'Reports\\'
        ]
    ]
];</code></pre>
    </div>

    <div class="alert alert-success">
        <i class="fas fa-check-circle me-2"></i>
        <strong>Best Practice:</strong> Keep modules focused on specific functionality. For example, Admin for administration, Api for REST APIs, Reports for reporting features.
    </div>
</section>